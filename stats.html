<!DOCTYPE html>
<html lang="en">

<head>
  <title>Stats</title>
  <meta charset="UTF-8">
  <link rel="shortcut icon" href="img/favicon.png" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="normalize.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
  <link rel="stylesheet" href="./css/style.css">
</head>

<body>
  <header>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark bg-gradient">
      <a class="navbar-brand d-flex align-items-center " href="/"></a>
      <div class="logo-container">
        <h1 class="visually-hidden">Amazing Events</h1>
        <img src="./img/amazing_brand.png" alt="aevents" width="120" height="30">
      </div>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="nav gap-3 ms-md-auto mt-4 mb-lg-2 px-lg-5">
          <li class="nav-item">
            <a class="btn btn-primary" href="index.html" role="button">Home</a>
          </li>
          <li class="nav-item">
            <a class="btn btn-primary" href="upcoming.html" role="button">Upcoming Events</a>
          </li>
          <li class="nav-item">
            <a class="btn btn-primary" href="past.html" role="button">Past Events</a>
          </li>
          <li class="nav-item">
            <a class="btn btn-primary" href="contact.html" role="button">Contact</a>
          </li>
          <li class="nav-item">
            <a class="btn btn-dark bg-dark bg-gradient" href="#" aria-current="page" role="button">Stats</a>
          </li>
        </ul>
      </div>
    </nav>
  </header>
  <main>
    <table class="table table-dark table-bordered">
      <thead class="thead-light">
        <tr>
          <th>Categories</th>
          <th>Revenues</th>
          <th>Percentage of attendance</th>
        </tr>
      </thead>
      <tbody id="eventTableBody">
      </tbody>
    </table>

  </main>
  <footer class="d-flex flex-wrap justify-content-between align-items-center py-3 my-1 border-top">
    <div class="col-md-4 d-flex align-items-center">
      <span class="mb-3 mb-md-0 text-muted ms-4">Â© 2023 Cohort 03</span>
    </div>
    <ul class="nav col-md-4 justify-content-end list-unstyled d-flex me-4">
      <li class="me-4"><a class="text-muted" href="#"><i class="fab fa-whatsapp"></i></a></li>
      <li class="me-4"><a class="text-muted" href="#"><i class="fab fa-instagram"></i></a></li>
      <li class="me-4"><a class="text-muted" href="#"><i class="fab fa-facebook"></i></a></li>
      
    </ul>
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    
    const tableBody = document.getElementById('eventTableBody');

    //Fetch
    fetch('https://mindhub-xj03.onrender.com/api/amazing/')
      .then(response => response.json())
      .then(data => {
        
        const currentDate = new Date(data.currentDate);
        const upcomingEvents = data.events.filter(event => new Date(event.date) > currentDate);
        const pastEvents = data.events.filter(event => new Date(event.date) <= currentDate);

        
        function addRow(category, revenues, attendance, capacity) {
          const categoryRow = document.createElement('tr');

          const categoryCell = document.createElement('td');
          categoryCell.textContent = category;
          categoryRow.appendChild(categoryCell);

          const revenuesCell = document.createElement('td');
          revenuesCell.textContent = '$' + revenues.toFixed(2);
          categoryRow.appendChild(revenuesCell);

          const attendanceCell = document.createElement('td');
          const attendancePercentage = ((attendance / capacity) * 100).toFixed(2);
          attendanceCell.textContent = attendancePercentage + '%';
          categoryRow.appendChild(attendanceCell);

          tableBody.appendChild(categoryRow);
        }

        
        const categorizedDataUpcoming = {};
        upcomingEvents.forEach(event => {
          const category = event.category;
          const assistance = event.assistance || event.estimate;
          const price = event.price;
          const capacity = event.capacity;

          if (typeof assistance === 'number' && typeof price === 'number' && typeof capacity === 'number') {
            const eventRevenue = assistance * price;

            if (!categorizedDataUpcoming[category]) {
              categorizedDataUpcoming[category] = { revenues: 0, attendance: 0, capacity: 0 };
            }

            categorizedDataUpcoming[category].revenues += eventRevenue;
            categorizedDataUpcoming[category].attendance += assistance;
            categorizedDataUpcoming[category].capacity += capacity;
          }
        });

        
        tableBody.innerHTML += '<tr><th colspan="3" class="text-center">Upcoming Events Statistics</th></tr>';
        for (const category in categorizedDataUpcoming) {
          const { revenues, attendance, capacity } = categorizedDataUpcoming[category];
          addRow(category, revenues, attendance, capacity);
        }

        
        const categorizedDataPast = {};
        pastEvents.forEach(event => {
          const category = event.category;
          const assistance = event.assistance || event.estimate;
          const price = event.price;
          const capacity = event.capacity;

          if (typeof assistance === 'number' && typeof price === 'number' && typeof capacity === 'number') {
            const eventRevenue = assistance * price;

            if (!categorizedDataPast[category]) {
              categorizedDataPast[category] = { revenues: 0, attendance: 0, capacity: 0 };
            }

            categorizedDataPast[category].revenues += eventRevenue;
            categorizedDataPast[category].attendance += assistance;
            categorizedDataPast[category].capacity += capacity;
          }
        });

        
        tableBody.innerHTML += '<tr><th colspan="3" class="text-center">Past Events Statistics</th></tr>';
        for (const category in categorizedDataPast) {
          const { revenues, attendance, capacity } = categorizedDataPast[category];
          addRow(category, revenues, attendance, capacity);
        }

        
        let maxAttendancePercentage = 0;
        let maxAttendanceEvent = null;
        data.events.forEach(event => {
          const assistance = event.assistance || event.estimate;
          const capacity = event.capacity;

          if (typeof assistance === 'number' && typeof capacity === 'number') {
            const attendancePercentage = (assistance / capacity) * 100;
            if (attendancePercentage > maxAttendancePercentage) {
              maxAttendancePercentage = attendancePercentage;
              maxAttendanceEvent = event;
            }
          }
        });

        
        let minAttendance = Infinity;
        let minAttendanceEvent = null;
        data.events.forEach(event => {
          const assistance = event.assistance || event.estimate;
          if (typeof assistance === 'number') {
            if (assistance < minAttendance) {
              minAttendance = assistance;
              minAttendanceEvent = event;
            }
          }
        });

        
        let maxCapacity = 0;
        let maxCapacityEvent = null;
        data.events.forEach(event => {
          const capacity = event.capacity;
          if (typeof capacity === 'number') {
            if (capacity > maxCapacity) {
              maxCapacity = capacity;
              maxCapacityEvent = event;
            }
          }
        });

        
        const statisticsRow = document.createElement('tr');

        const statisticsCell = document.createElement('td');
        statisticsCell.colSpan = 3;
        statisticsCell.textContent = 'Event Statistics';
        statisticsCell.classList.add('text-center');
        statisticsRow.appendChild(statisticsCell);

        tableBody.appendChild(statisticsRow);

        
        const maxAttendanceRow = document.createElement('tr');
        maxAttendanceRow.innerHTML = `<td>Highest Assistance Percentage</td>
        <td><a href="details.html?id=${maxAttendanceEvent._id}" class="btn btn-primary">${maxAttendanceEvent.name}</a></td>
                                       <td>${maxAttendancePercentage.toFixed(2)}%</td>`;
        tableBody.appendChild(maxAttendanceRow);

        
        const minAttendanceRow = document.createElement('tr');
        minAttendanceRow.innerHTML = `<td>Lower Assistance </td>
        <td><a href="details.html?id=${minAttendanceEvent._id}" class="btn btn-primary">${minAttendanceEvent.name}</a></td>
                                       <td>${minAttendance}</td>`;
        tableBody.appendChild(minAttendanceRow);

        
        const maxCapacityRow = document.createElement('tr');
        maxCapacityRow.innerHTML = `<td>Larger Capacity</td>
        <td><a href="details.html?id=${maxCapacityEvent._id}" class="btn btn-primary">${maxCapacityEvent.name}</a></td>
                                     <td>${maxCapacity}</td>`;
        tableBody.appendChild(maxCapacityRow);
      })
      .catch(error => {
        console.error('Error al obtener los eventos:', error);
      });

  </script>

</body>

</html>